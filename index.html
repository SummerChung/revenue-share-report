<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Excel åˆ†æ½¤å ±è¡¨è½‰æ›å·¥å…·</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", Arial, sans-serif;
      background: linear-gradient(to bottom right, #fefce8, #fef3c7);
      min-height: 100vh;
      padding: 2rem;
    }
    .container { max-width: 960px; margin: 0 auto; }
    .card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      border-top: 4px solid #FFC800;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
    }
    .header-title { display: flex; align-items: center; gap: 0.75rem; }
    .header-title svg { width: 2rem; height: 2rem; color: #FFC800; }
    .header-title h1 { font-size: 1.875rem; font-weight: bold; color: #1f2937; }
    .copy-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: #f3f4f6;
      color: #374151;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 0.875rem;
    }
    .copy-btn:hover { background: #e5e7eb; }
    .copy-btn svg { width: 1rem; height: 1rem; }
    .info-box {
      background: #fefce8;
      border-left: 4px solid #FFC800;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .info-box h2 { font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; }
    .info-box ul { list-style: none; font-size: 0.875rem; color: #374151; }
    .info-box li { margin-top: 0.25rem; }
    .info-box .highlight { font-weight: 600; color: #a16207; }
    .file-input-wrapper { margin-bottom: 1.5rem; }
    .file-input-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
    }
    .file-input-box {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      border: 2px dashed #d1d5db;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .file-input-box:hover { border-color: #FFC800; background: #fefce8; }
    .file-input-box svg { width: 1.5rem; height: 1.5rem; color: #9ca3af; margin-right: 0.5rem; }
    .file-input-box span { color: #4b5563; }
    .file-input-box input { display: none; }
    .process-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      background: #FFC800;
      color: #000;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .process-btn:hover:not(:disabled) { background: #fbbf24; }
    .process-btn:disabled { background: #d1d5db; cursor: not-allowed; }
    .process-btn svg { width: 1.25rem; height: 1.25rem; }
    .spinner {
      display: inline-block;
      width: 1.25rem;
      height: 1.25rem;
      border: 2px solid #000;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error-box {
      margin-top: 1.5rem;
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 0.5rem;
      padding: 1rem;
      display: flex;
      gap: 0.75rem;
    }
    .error-box svg { width: 1.25rem; height: 1.25rem; color: #dc2626; flex-shrink: 0; margin-top: 0.125rem; }
    .error-box h3 { font-weight: 600; color: #7f1d1d; }
    .error-box p { color: #991b1b; font-size: 0.875rem; }
    .result-box {
      margin-top: 1.5rem;
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 0.5rem;
      padding: 1rem;
    }
    .result-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
    .result-header svg { width: 1.5rem; height: 1.5rem; color: #16a34a; }
    .result-header h3 { font-weight: 600; color: #14532d; }
    .download-all-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: #16a34a;
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 1rem;
    }
    .download-all-btn:hover { background: #15803d; }
    .download-all-btn svg { width: 1.25rem; height: 1.25rem; }
    .file-list { max-height: 384px; overflow-y: auto; }
    .file-item {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: box-shadow 0.2s;
    }
    .file-item:hover { box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
    .file-info { flex: 1; }
    .file-info .name { font-weight: 500; color: #1f2937; }
    .file-info .address { font-size: 0.875rem; color: #4b5563; margin-top: 0.25rem; }
    .file-info .details { display: flex; gap: 1rem; margin-top: 0.5rem; }
    .file-info .details p { font-size: 0.875rem; color: #6b7280; }
    .file-info .details span { font-weight: 600; }
    .file-actions { display: flex; gap: 0.5rem; margin-left: 1rem; }
    .download-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: #fef3c7;
      color: #78350f;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .download-btn:hover { background: #fde68a; }
    .download-btn svg { width: 1rem; height: 1rem; }
    .tip-box {
      margin-top: 1rem;
      background: #fefce8;
      border-left: 4px solid #FFC800;
      border-radius: 0.5rem;
      padding: 0.75rem;
    }
    .tip-box p { font-size: 0.875rem; color: #78350f; line-height: 1.6; }
    .footer { margin-top: 1.5rem; text-align: center; font-size: 0.875rem; color: #4b5563; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="header-title">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <h1>Excel åˆ†æ½¤å ±è¡¨è½‰æ›å·¥å…·</h1>
        </div>
        <button class="copy-btn" onclick="copyUrl()">
          <svg id="copyIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
          </svg>
          <span id="copyText">è¤‡è£½ç¶²å€</span>
        </button>
      </div>

      <div class="info-box">
        <h2>è™•ç†èªªæ˜ï¼š</h2>
        <ul>
          <li>â€¢ è«‹ç™»å…¥ EIPS ç³»çµ± â†’ è²¡å‹™ â†’ ä¸‹å±åˆ†æ½¤é é¢ï¼Œä¸‹è¼‰ç¤¾å€åˆ†æ½¤å ±è¡¨</li>
          <li>â€¢ ä¸Šå‚³ç¤¾å€åˆ†æ½¤å ±è¡¨</li>
          <li>â€¢ ç³»çµ±å°‡ç‚ºæ¯å€‹ç¤¾å€çš„æ¯å€‹æœˆä»½ï¼Œè‡ªå‹•ç”¢ç”Ÿä¸€å€‹ç¨ç«‹çš„ HTML æª”æ¡ˆ</li>
          <li>â€¢ ä¸‹è¼‰å®Œæˆå¾Œï¼Œå¯ç›´æ¥ä»¥ ç€è¦½å™¨é–‹å•Ÿï¼Œä¸¦é¸æ“‡ã€Œåˆ—å°ç‚º PDFã€ä»¥ç”¢å‡ºæ­£å¼å ±è¡¨</li>
        </ul>
      </div>

      <div class="file-input-wrapper">
        <label class="file-input-label">é¸æ“‡ Excel æª”æ¡ˆ</label>
        <label class="file-input-box" for="fileInput">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          <span id="fileLabel">é»æ“Šé¸æ“‡æª”æ¡ˆ</span>
          <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none;">
        </label>
      </div>

      <button class="process-btn" id="processBtn" onclick="processExcel()" disabled>
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <span>é–‹å§‹è™•ç†</span>
      </button>

      <div id="errorBox" class="error-box hidden">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div>
          <h3>éŒ¯èª¤</h3>
          <p id="errorMessage"></p>
        </div>
      </div>

      <div id="resultBox" class="result-box hidden">
        <div class="result-header">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <h3 id="resultTitle"></h3>
        </div>

        <button class="download-all-btn" onclick="downloadAll()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
          </svg>
          <span>ä¸‹è¼‰å…¨éƒ¨æª”æ¡ˆ(ZIP å£“ç¸®æª”)</span>
        </button>

        <div id="fileList" class="file-list"></div>

        <div class="tip-box">
          <p>
            <strong>ğŸ’¡ å¦‚ä½•è½‰æˆ PDF:</strong><br/>
            1. ä¸‹è¼‰ HTML æª”æ¡ˆ<br/>
            2. ç”¨ç€è¦½å™¨(Chrome/Edge)é–‹å•Ÿæª”æ¡ˆ<br/>
            3. æŒ‰ Ctrl+P (Windows) æˆ– Cmd+P (Mac)<br/>
            4. é¸æ“‡ã€Œå¦å­˜ç‚º PDFã€æˆ–ã€ŒMicrosoft Print to PDFã€<br/>
            5. å„²å­˜æª”æ¡ˆ
          </p>
        </div>
      </div>
    </div>

    <div class="footer">
      <p>æ”¯æ´ .xlsx å’Œ .xls æ ¼å¼ | ç›´å¼ A4 æ’ç‰ˆ | EipTV é»ƒé»‘ä¼æ¥­é…è‰²</p>
    </div>
  </div>

  <script>
    let selectedFile = null;
    let processedFiles = [];

    document.getElementById('fileInput').addEventListener('change', function(e) {
      selectedFile = e.target.files[0];
      if (selectedFile) {
        document.getElementById('fileLabel').textContent = selectedFile.name;
        document.getElementById('processBtn').disabled = false;
        document.getElementById('errorBox').classList.add('hidden');
        document.getElementById('resultBox').classList.add('hidden');
      }
    });

    function generateHTMLContent(headers, rows, communityName, profitMonth) {
      const selectedHeaders = [headers[1], headers[2], headers[5], headers[6]];
      const selectedRows = rows.map(row => [row[1], row[2], row[5], row[6]]);
      return `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>${communityName}-åˆ†çœ¾å»£å‘Šåˆ†æ½¤å°å¸³å–®-${profitMonth}</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    @page { size: A4 portrait; margin: 15mm; }
    body { font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", Arial, sans-serif; padding: 20px; background: white; line-height: 1.6; }
    .header { text-align: center; margin-bottom: 25px; page-break-after: avoid; padding-bottom: 15px; }
    .header h1 { font-size: 24px; color: #000000; margin-bottom: 10px; font-weight: bold; }
    .header .info { font-size: 13px; color: #4b5563; margin-top: 6px; }
    .table-container { width: 100%; overflow: visible; margin-top: 15px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11.5px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
    th, td { border: 2px solid #d1d5db; padding: 10px 12px; text-align: left; word-wrap: break-word; overflow-wrap: break-word; white-space: normal; vertical-align: middle; }
    th { background-color: #FFC800; color: #000000; font-weight: bold; font-size: 12pt; text-align: center; }
    tr:nth-child(even) { background-color: #FFFBEA; }
    tr:nth-child(odd) { background-color: #ffffff; }
    tbody tr:hover { background-color: #FFF4CC; }
    th:nth-child(1), td:nth-child(1) { width: 25%; font-weight: normal; }
    th:nth-child(1) { text-align: center; font-weight: bold; }
    th:nth-child(2), td:nth-child(2) { width: 35%; font-weight: normal; }
    th:nth-child(2) { text-align: center; font-weight: bold; }
    th:nth-child(3), td:nth-child(3) { width: 18%; text-align: center; font-weight: normal; }
    th:nth-child(3) { font-weight: bold; }
    th:nth-child(4), td:nth-child(4) { width: 22%; text-align: right; font-weight: normal; }
    th:nth-child(4) { text-align: center; font-weight: bold; }
    .footer { margin-top: 30px; padding-top: 15px; text-align: center; font-size: 11px; color: #6b7280; border-top: 1.5px solid #FFC800; page-break-inside: avoid; }
    @media print {
      body { padding: 0; background: white; }
      .header { margin-bottom: 20px; }
      table { page-break-inside: auto; box-shadow: none; }
      tr { page-break-inside: avoid; page-break-after: auto; }
      thead { display: table-header-group; }
      tfoot { display: table-footer-group; }
      th, td { border: 1.2px solid #d1d5db; }
      th { -webkit-print-color-adjust: exact; print-color-adjust: exact; color-adjust: exact; background-color: #FFC800 !important; color: #000000 !important; }
      tr:nth-child(even) { -webkit-print-color-adjust: exact; print-color-adjust: exact; background-color: #FFFBEA !important; }
      tbody tr:hover { background-color: #FFF4CC !important; }
      .footer { border-top: 1.5px solid #FFC800; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>${communityName} - åˆ†çœ¾å»£å‘Šåˆ†æ½¤å°å¸³å–®</h1>
    <div class="info">åˆ†æ½¤å¹´æœˆï¼š${profitMonth}</div>
    <div class="info">ç”¢ç”Ÿæ—¥æœŸï¼š${new Date().toLocaleDateString('zh-TW')}</div>
  </div>
  <div class="table-container">
    <table>
      <thead><tr>${selectedHeaders.map(h => `<th>${h || ''}</th>`).join('')}</tr></thead>
      <tbody>${selectedRows.map(row => `<tr>${row.map(cell => `<td>${cell !== null && cell !== undefined ? cell : ''}</td>`).join('')}</tr>`).join('')}</tbody>
    </table>
  </div>
  <div class="footer"><p>å…± ${selectedRows.length} ç­†è³‡æ–™</p></div>
</body>
</html>`;
    }

    async function processExcel() {
      if (!selectedFile) return;
      const processBtn = document.getElementById('processBtn');
      processBtn.disabled = true;
      processBtn.innerHTML = '<span class="spinner"></span><span>è™•ç†ä¸­...</span>';
      document.getElementById('errorBox').classList.add('hidden');
      document.getElementById('resultBox').classList.add('hidden');

      try {
        const data = await selectedFile.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

        if (jsonData.length < 2) throw new Error('Excel æª”æ¡ˆæ²’æœ‰è¶³å¤ çš„è³‡æ–™');

        const headers = jsonData[0];
        const dataRows = jsonData.slice(1);
        const groupedData = {};

        dataRows.forEach((row, index) => {
          if (!row || row.length === 0) return;
          const communityId = row[0]?.toString().trim();
          const communityName = row[1]?.toString().trim();
          const address = row[2]?.toString().trim();
          const profitMonth = row[5]?.toString().trim();
          const profitAmount = row[6]?.toString().trim();

          if (!communityId || !communityName || !profitMonth) {
            console.warn(`ç¬¬ ${index + 2} åˆ—è³‡æ–™ä¸å®Œæ•´,å·²è·³é`);
            return;
          }

          const key = `${communityId}_${profitMonth}`;
          if (!groupedData[key]) {
            groupedData[key] = {
              communityId, communityName, address: address || '', profitMonth,
              profitAmount: profitAmount || '0', rows: []
            };
          }
          groupedData[key].rows.push(row);
        });

        processedFiles = Object.entries(groupedData).map(([key, data]) => {
          const htmlContent = generateHTMLContent(headers, data.rows, data.communityName, data.profitMonth);
          const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
          return {
            key, fileName: `${data.communityName}-åˆ†çœ¾å»£å‘Šåˆ†æ½¤å°å¸³å–®-${data.profitMonth}.html`,
            communityName: data.communityName, address: data.address,
            profitMonth: data.profitMonth, profitAmount: data.profitAmount,
            rowCount: data.rows.length, blob: blob
          };
        });

        showResults();
      } catch (err) {
        showError(err.message || 'è™•ç†æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤');
      } finally {
        processBtn.disabled = false;
        processBtn.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>é–‹å§‹è™•ç†</span>';
      }
    }

    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorBox').classList.remove('hidden');
    }

    function showResults() {
      document.getElementById('resultTitle').textContent = `è™•ç†å®Œæˆ!å…±ç”¢ç”Ÿ ${processedFiles.length} å€‹æª”æ¡ˆ`;
      const fileList = document.getElementById('fileList');
      fileList.innerHTML = processedFiles.map((file, index) => `
        <div class="file-item">
          <div class="file-info">
            <div class="name">${file.communityName}</div>
            <div class="address">${file.address}</div>
            <div class="details">
              <p><span>åˆ†æ½¤å¹´æœˆï¼š</span>${file.profitMonth}</p>
              <p><span>åˆ†æ½¤é‡‘é¡ï¼š</span>${file.profitAmount}</p>
            </div>
          </div>
          <div class="file-actions">
            <button class="download-btn" onclick="downloadFile(${index})">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
              </svg>
              <span>ä¸‹è¼‰</span>
            </button>
          </div>
        </div>
      `).join('');
      document.getElementById('resultBox').classList.remove('hidden');
    }

    function downloadFile(index) {
      const file = processedFiles[index];
      const url = URL.createObjectURL(file.blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = file.fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    async function downloadAll() {
      try {
        const zip = new JSZip();
        processedFiles.forEach((file) => {
          zip.file(file.fileName, file.blob);
        });
        const zipBlob = await zip.generateAsync({ type: 'blob' });
        const url = URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = url;
        const today = new Date();
        const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
        a.download = `åˆ†æ½¤å°å¸³å–®_${dateStr}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error('å£“ç¸®æª”æ¡ˆå¤±æ•—:', err);
        alert('ç”¢ç”Ÿå£“ç¸®æª”æ™‚ç™¼ç”ŸéŒ¯èª¤:' + err.message + '\nè«‹æ”¹ç”¨å€‹åˆ¥ä¸‹è¼‰ã€‚');
      }
    }

    function copyUrl() {
      navigator.clipboard.writeText(window.location.href).then(() => {
        document.getElementById('copyText').textContent = 'å·²è¤‡è£½';
        setTimeout(() => {
          document.getElementById('copyText').textContent = 'è¤‡è£½ç¶²å€';
        }, 2000);
      }).catch(err => {
        console.error('è¤‡è£½å¤±æ•—:', err);
      });
    }
  </script>
</body>
</html>